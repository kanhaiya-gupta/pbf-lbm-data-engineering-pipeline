# Defect Image Features Configuration
# Feature engineering for defect detection in PBF-LBM images

features:
  name: "defect_image_features"
  version: "1.0.0"
  description: "Feature engineering for defect detection in PBF-LBM images"
  
  input_schema:
    required_fields:
      - "timestamp"
      - "image_id"
      - "image_data"
      - "image_width"
      - "image_height"
      - "image_channels"
    optional_fields:
      - "defect_type"
      - "defect_severity"
      - "build_layer"
      - "material_type"
      - "laser_power"
      - "scan_speed"
      - "camera_settings"
      - "lighting_conditions"
      
  feature_groups:
    - name: "basic_statistical_features"
      description: "Basic statistical image features"
      features:
        - name: "mean_intensity"
          description: "Mean pixel intensity across the image"
          formula: "mean(image_data)"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "std_intensity"
          description: "Standard deviation of pixel intensities"
          formula: "std(image_data)"
          type: "numerical"
          range: [0.0, 128.0]
          unit: "pixel_value"
        - name: "median_intensity"
          description: "Median pixel intensity"
          formula: "median(image_data)"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "min_intensity"
          description: "Minimum pixel intensity"
          formula: "min(image_data)"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "max_intensity"
          description: "Maximum pixel intensity"
          formula: "max(image_data)"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "intensity_range"
          description: "Range of pixel intensities"
          formula: "max_intensity - min_intensity"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "contrast"
          description: "Image contrast measure"
          formula: "std_intensity / (mean_intensity + 1e-6)"
          type: "numerical"
          range: [0.0, 2.0]
          unit: "ratio"
        - name: "brightness"
          description: "Overall image brightness"
          formula: "mean_intensity / 255.0"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "normalized"
        - name: "variance_intensity"
          description: "Variance of pixel intensities"
          formula: "var(image_data)"
          type: "numerical"
          range: [0.0, 16384.0]
          unit: "pixel_value_squared"
        - name: "skewness_intensity"
          description: "Skewness of intensity distribution"
          formula: "skew(image_data)"
          type: "numerical"
          range: [-3.0, 3.0]
          unit: "dimensionless"
        - name: "kurtosis_intensity"
          description: "Kurtosis of intensity distribution"
          formula: "kurtosis(image_data)"
          type: "numerical"
          range: [0.0, 20.0]
          unit: "dimensionless"
          
    - name: "texture_features"
      description: "Texture analysis features"
      features:
        - name: "local_binary_pattern"
          description: "Local Binary Pattern texture descriptor"
          formula: "calculate_lbp(image_data, radius=1, n_points=8)"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pattern_value"
        - name: "gray_level_cooccurrence_matrix_contrast"
          description: "GLCM contrast measure"
          formula: "calculate_glcm_contrast(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "contrast_value"
        - name: "gray_level_cooccurrence_matrix_homogeneity"
          description: "GLCM homogeneity measure"
          formula: "calculate_glcm_homogeneity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "homogeneity_value"
        - name: "gray_level_cooccurrence_matrix_energy"
          description: "GLCM energy measure"
          formula: "calculate_glcm_energy(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "energy_value"
        - name: "gray_level_cooccurrence_matrix_correlation"
          description: "GLCM correlation measure"
          formula: "calculate_glcm_correlation(image_data)"
          type: "numerical"
          range: [-1.0, 1.0]
          unit: "correlation_value"
        - name: "gabor_filter_response"
          description: "Gabor filter response for texture analysis"
          formula: "calculate_gabor_response(image_data, frequency=0.1, theta=0)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "response_value"
        - name: "haralick_features"
          description: "Haralick texture features"
          formula: "calculate_haralick_features(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "feature_value"
        - name: "entropy"
          description: "Image entropy measure"
          formula: "calculate_entropy(image_data)"
          type: "numerical"
          range: [0.0, 8.0]
          unit: "bits"
        - name: "uniformity"
          description: "Image uniformity measure"
          formula: "calculate_uniformity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "uniformity_value"
        - name: "smoothness"
          description: "Image smoothness measure"
          formula: "calculate_smoothness(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "smoothness_value"
          
    - name: "edge_features"
      description: "Edge detection and analysis features"
      features:
        - name: "canny_edge_density"
          description: "Density of Canny edges"
          formula: "calculate_canny_edge_density(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "edge_density"
        - name: "sobel_edge_magnitude"
          description: "Sobel edge magnitude"
          formula: "calculate_sobel_magnitude(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "magnitude_value"
        - name: "laplacian_variance"
          description: "Variance of Laplacian operator response"
          formula: "calculate_laplacian_variance(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "variance_value"
        - name: "edge_orientation_histogram"
          description: "Histogram of edge orientations"
          formula: "calculate_edge_orientation_histogram(image_data, bins=8)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "histogram_value"
        - name: "hough_line_count"
          description: "Number of detected lines using Hough transform"
          formula: "calculate_hough_lines(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "line_count"
        - name: "corner_count"
          description: "Number of detected corners"
          formula: "calculate_corners(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "corner_count"
          
    - name: "defect_specific_features"
      description: "Defect-specific detection features"
      features:
        - name: "defect_area"
          description: "Total area of detected defects"
          formula: "calculate_defect_area(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "pixels"
        - name: "defect_count"
          description: "Number of detected defects"
          formula: "calculate_defect_count(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "count"
        - name: "defect_density"
          description: "Density of defects in the image"
          formula: "defect_area / (image_width * image_height)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "density_ratio"
        - name: "defect_severity_score"
          description: "Overall defect severity score"
          formula: "calculate_severity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "severity_score"
        - name: "largest_defect_area"
          description: "Area of the largest defect"
          formula: "calculate_largest_defect_area(image_data)"
          type: "numerical"
          range: [0.0, 5000.0]
          unit: "pixels"
        - name: "defect_perimeter"
          description: "Total perimeter of all defects"
          formula: "calculate_defect_perimeter(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "pixels"
        - name: "defect_compactness"
          description: "Compactness measure of defects"
          formula: "calculate_defect_compactness(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "compactness_ratio"
        - name: "defect_circularity"
          description: "Circularity measure of defects"
          formula: "calculate_defect_circularity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "circularity_ratio"
        - name: "defect_eccentricity"
          description: "Eccentricity of defect shapes"
          formula: "calculate_defect_eccentricity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "eccentricity_ratio"
        - name: "defect_orientation"
          description: "Dominant orientation of defects"
          formula: "calculate_defect_orientation(image_data)"
          type: "numerical"
          range: [0.0, 180.0]
          unit: "degrees"
          
    - name: "frequency_domain_features"
      description: "Frequency domain analysis features"
      features:
        - name: "spectral_centroid"
          description: "Spectral centroid of the image"
          formula: "calculate_spectral_centroid(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "frequency_value"
        - name: "spectral_bandwidth"
          description: "Spectral bandwidth of the image"
          formula: "calculate_spectral_bandwidth(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "frequency_value"
        - name: "spectral_rolloff"
          description: "Spectral rolloff frequency"
          formula: "calculate_spectral_rolloff(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "frequency_value"
        - name: "spectral_flatness"
          description: "Spectral flatness measure"
          formula: "calculate_spectral_flatness(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "flatness_ratio"
        - name: "spectral_contrast"
          description: "Spectral contrast measure"
          formula: "calculate_spectral_contrast(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "contrast_ratio"
        - name: "spectral_energy"
          description: "Total spectral energy"
          formula: "calculate_spectral_energy(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "energy_value"
        - name: "spectral_entropy"
          description: "Spectral entropy measure"
          formula: "calculate_spectral_entropy(image_data)"
          type: "numerical"
          range: [0.0, 8.0]
          unit: "bits"
        - name: "spectral_kurtosis"
          description: "Spectral kurtosis measure"
          formula: "calculate_spectral_kurtosis(image_data)"
          type: "numerical"
          range: [0.0, 20.0]
          unit: "kurtosis_value"
        - name: "spectral_skewness"
          description: "Spectral skewness measure"
          formula: "calculate_spectral_skewness(image_data)"
          type: "numerical"
          range: [-3.0, 3.0]
          unit: "skewness_value"
          
    - name: "morphological_features"
      description: "Morphological analysis features"
      features:
        - name: "erosion_count"
          description: "Number of objects after erosion"
          formula: "calculate_erosion_count(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "object_count"
        - name: "dilation_count"
          description: "Number of objects after dilation"
          formula: "calculate_dilation_count(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "object_count"
        - name: "opening_count"
          description: "Number of objects after opening"
          formula: "calculate_opening_count(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "object_count"
        - name: "closing_count"
          description: "Number of objects after closing"
          formula: "calculate_closing_count(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "object_count"
        - name: "skeleton_length"
          description: "Total length of skeletonized objects"
          formula: "calculate_skeleton_length(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "pixels"
        - name: "convex_hull_area"
          description: "Area of convex hull of objects"
          formula: "calculate_convex_hull_area(image_data)"
          type: "numerical"
          range: [0.0, 10000.0]
          unit: "pixels"
        - name: "convex_hull_ratio"
          description: "Ratio of object area to convex hull area"
          formula: "calculate_convex_hull_ratio(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "ratio"
        - name: "solidity"
          description: "Solidity measure of objects"
          formula: "calculate_solidity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "solidity_ratio"
        - name: "extent"
          description: "Extent measure of objects"
          formula: "calculate_extent(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "extent_ratio"
        - name: "equivalent_diameter"
          description: "Equivalent diameter of objects"
          formula: "calculate_equivalent_diameter(image_data)"
          type: "numerical"
          range: [0.0, 1000.0]
          unit: "pixels"
          
    - name: "color_features"
      description: "Color analysis features (if applicable)"
      features:
        - name: "mean_red"
          description: "Mean red channel intensity"
          formula: "mean(image_data[:,:,0])"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "mean_green"
          description: "Mean green channel intensity"
          formula: "mean(image_data[:,:,1])"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "mean_blue"
          description: "Mean blue channel intensity"
          formula: "mean(image_data[:,:,2])"
          type: "numerical"
          range: [0.0, 255.0]
          unit: "pixel_value"
        - name: "color_variance"
          description: "Variance across color channels"
          formula: "var([mean_red, mean_green, mean_blue])"
          type: "numerical"
          range: [0.0, 16384.0]
          unit: "variance_value"
        - name: "color_entropy"
          description: "Entropy of color distribution"
          formula: "calculate_color_entropy(image_data)"
          type: "numerical"
          range: [0.0, 8.0]
          unit: "bits"
        - name: "dominant_color"
          description: "Dominant color in the image"
          formula: "calculate_dominant_color(image_data)"
          type: "categorical"
          values: ["red", "green", "blue", "gray", "mixed"]
        - name: "color_histogram_peaks"
          description: "Number of peaks in color histogram"
          formula: "calculate_color_histogram_peaks(image_data)"
          type: "numerical"
          range: [1.0, 10.0]
          unit: "peak_count"
        - name: "color_uniformity"
          description: "Uniformity of color distribution"
          formula: "calculate_color_uniformity(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "uniformity_ratio"
        - name: "color_contrast"
          description: "Color contrast measure"
          formula: "calculate_color_contrast(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "contrast_ratio"
        - name: "color_saturation"
          description: "Average color saturation"
          formula: "calculate_color_saturation(image_data)"
          type: "numerical"
          range: [0.0, 1.0]
          unit: "saturation_ratio"
          
  preprocessing:
    image_processing:
      resize:
        enabled: true
        target_size: [512, 512]
        method: "bilinear"
      normalization:
        enabled: true
        method: "min_max"
        range: [0.0, 1.0]
      denoising:
        enabled: true
        method: "gaussian"
        kernel_size: 3
        sigma: 1.0
      contrast_enhancement:
        enabled: true
        method: "clahe"
        clip_limit: 2.0
        tile_grid_size: [8, 8]
      histogram_equalization:
        enabled: true
        method: "adaptive"
        clip_limit: 0.03
      edge_enhancement:
        enabled: true
        method: "unsharp_mask"
        radius: 1.0
        amount: 1.0
        threshold: 0.0
        
    feature_scaling:
      method: "robust_scaler"
      features: ["mean_intensity", "std_intensity", "median_intensity", "min_intensity", "max_intensity",
                "intensity_range", "contrast", "brightness", "variance_intensity", "skewness_intensity",
                "kurtosis_intensity", "local_binary_pattern", "gray_level_cooccurrence_matrix_contrast",
                "gray_level_cooccurrence_matrix_homogeneity", "gray_level_cooccurrence_matrix_energy",
                "gray_level_cooccurrence_matrix_correlation", "gabor_filter_response", "haralick_features",
                "entropy", "uniformity", "smoothness", "canny_edge_density", "sobel_edge_magnitude",
                "laplacian_variance", "edge_orientation_histogram", "hough_line_count", "corner_count",
                "defect_area", "defect_count", "defect_density", "defect_severity_score", "largest_defect_area",
                "defect_perimeter", "defect_compactness", "defect_circularity", "defect_eccentricity",
                "defect_orientation", "spectral_centroid", "spectral_bandwidth", "spectral_rolloff",
                "spectral_flatness", "spectral_contrast", "spectral_energy", "spectral_entropy",
                "spectral_kurtosis", "spectral_skewness", "erosion_count", "dilation_count", "opening_count",
                "closing_count", "skeleton_length", "convex_hull_area", "convex_hull_ratio", "solidity",
                "extent", "equivalent_diameter", "mean_red", "mean_green", "mean_blue", "color_variance",
                "color_entropy", "color_histogram_peaks", "color_uniformity", "color_contrast", "color_saturation"]
                
    feature_selection:
      method: "mutual_info_classification"
      k_best: 50
      threshold: 0.01
      
  validation:
    business_rules:
      - name: "intensity_range_check"
        condition: "mean_intensity >= 0 AND mean_intensity <= 255"
        action: "flag_invalid"
      - name: "image_size_check"
        condition: "image_width > 0 AND image_height > 0"
        action: "flag_invalid"
      - name: "defect_area_check"
        condition: "defect_area >= 0 AND defect_area <= 10000"
        action: "flag_invalid"
      - name: "defect_density_check"
        condition: "defect_density >= 0 AND defect_density <= 1"
        action: "flag_invalid"
      - name: "contrast_check"
        condition: "contrast >= 0 AND contrast <= 2"
        action: "flag_invalid"
      - name: "brightness_check"
        condition: "brightness >= 0 AND brightness <= 1"
        action: "flag_invalid"
      - name: "entropy_check"
        condition: "entropy >= 0 AND entropy <= 8"
        action: "flag_invalid"
      - name: "spectral_energy_check"
        condition: "spectral_energy >= 0"
        action: "flag_invalid"
        
    data_quality_checks:
      - name: "image_completeness"
        condition: "image_data is not null AND image_data.size > 0"
        action: "flag_incomplete"
      - name: "image_dimensions"
        condition: "image_width > 100 AND image_height > 100"
        action: "flag_invalid"
      - name: "image_channels"
        condition: "image_channels in [1, 3]"
        action: "flag_invalid"
      - name: "image_format"
        condition: "image_data.dtype in ['uint8', 'float32']"
        action: "flag_invalid"
        
  monitoring:
    drift_detection:
      enabled: true
      method: "psi"
      threshold: 0.1
      features: ["mean_intensity", "std_intensity", "contrast", "brightness", "entropy", "defect_density"]
    performance_monitoring:
      enabled: true
      metrics: ["feature_completeness", "feature_quality", "processing_time"]
      alert_thresholds:
        feature_completeness: 0.95
        feature_quality: 0.9
        processing_time_seconds: 30
        
  storage:
    feature_cache:
      enabled: true
      ttl: "1_hour"
      max_size: "1GB"
    feature_archive:
      enabled: true
      retention_days: 30
      compression: "gzip"
      
  integration:
    mlflow:
      enabled: true
      tracking_uri: "http://mlflow:5000"
      experiment_name: "defect_image_features"
    feast:
      enabled: true
      registry_path: "/data/feature_store/registry/"
      online_store: "redis://redis-feature-store:6379"
    airflow:
      enabled: true
      dag_id: "defect_image_features_pipeline"
      schedule_interval: "0 * * * *"

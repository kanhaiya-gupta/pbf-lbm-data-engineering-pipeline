# Process Optimization Service Configuration
# ========================================

service:
  name: "process_optimization_service"
  version: "1.0.0"
  description: "Real-time API service for process optimization in PBF-LB/M processes"
  type: "api_gateway"
  port: 8080
  host: "0.0.0.0"
  
  # Service metadata
  metadata:
    author: "ML Team"
    created_date: "2024-01-01"
    last_updated: "2024-01-01"
    tags: ["process_optimization", "real_time", "api", "pbf"]

# Service Endpoints
endpoints:
  - name: "optimize_laser_parameters"
    path: "/api/v1/optimize/laser_parameters"
    method: "POST"
    description: "Optimize laser parameters for PBF-LB/M process"
    
    # Input schema
    input_schema:
      type: "object"
      properties:
        material_type: 
          type: "string"
          enum: ["Inconel_718", "Ti6Al4V", "316L_Stainless", "AlSi10Mg"]
          description: "Type of material being processed"
        part_geometry_complexity: 
          type: "number"
          minimum: 0
          maximum: 10
          description: "Geometric complexity score of the part"
        part_volume: 
          type: "number"
          minimum: 0
          maximum: 1000
          description: "Volume of the part in cm³"
        part_surface_area: 
          type: "number"
          minimum: 0
          maximum: 10000
          description: "Surface area of the part in cm²"
        aspect_ratio: 
          type: "number"
          minimum: 0
          maximum: 100
          description: "Aspect ratio of the part"
        wall_thickness_min: 
          type: "number"
          minimum: 0.1
          maximum: 10
          description: "Minimum wall thickness in mm"
        overhang_angle_max: 
          type: "number"
          minimum: 0
          maximum: 90
          description: "Maximum overhang angle in degrees"
        support_volume_ratio: 
          type: "number"
          minimum: 0
          maximum: 1
          description: "Ratio of support volume to part volume"
        build_orientation_x: 
          type: "number"
          minimum: 0
          maximum: 1
          description: "X-component of build orientation vector"
        build_orientation_y: 
          type: "number"
          minimum: 0
          maximum: 1
          description: "Y-component of build orientation vector"
        build_orientation_z: 
          type: "number"
          minimum: 0
          maximum: 1
          description: "Z-component of build orientation vector"
        chamber_temperature: 
          type: "number"
          minimum: 20
          maximum: 200
          description: "Build chamber temperature in °C"
        oxygen_level: 
          type: "number"
          minimum: 0
          maximum: 1000
          description: "Oxygen level in chamber in ppm"
        powder_bed_temperature: 
          type: "number"
          minimum: 20
          maximum: 200
          description: "Powder bed temperature in °C"
        powder_flow_rate: 
          type: "number"
          minimum: 0
          maximum: 50
          description: "Powder flow rate in g/min"
        recoater_speed: 
          type: "number"
          minimum: 10
          maximum: 200
          description: "Recoater speed in mm/s"
        build_plate_material: 
          type: "string"
          enum: ["Steel", "Aluminum", "Titanium"]
          description: "Material of the build plate"
        build_plate_temperature: 
          type: "number"
          minimum: 20
          maximum: 300
          description: "Build plate temperature in °C"
        atmospheric_pressure: 
          type: "number"
          minimum: 0
          maximum: 2000
          description: "Atmospheric pressure in mbar"
        humidity: 
          type: "number"
          minimum: 0
          maximum: 100
          description: "Humidity in %"
        vibration_level: 
          type: "number"
          minimum: 0
          maximum: 10
          description: "Vibration level in mm/s"
      required: ["material_type", "part_geometry_complexity", "part_volume", "wall_thickness_min", "overhang_angle_max"]
    
    # Output schema
    output_schema:
      type: "object"
      properties:
        optimal_parameters:
          type: "object"
          properties:
            optimal_laser_power: 
              type: "number"
              minimum: 50
              maximum: 1000
              description: "Optimal laser power in Watts"
            optimal_scan_speed: 
              type: "number"
              minimum: 100
              maximum: 2000
              description: "Optimal scan speed in mm/s"
            optimal_layer_thickness: 
              type: "number"
              minimum: 0.02
              maximum: 0.1
              description: "Optimal layer thickness in mm"
            optimal_hatch_spacing: 
              type: "number"
              minimum: 0.05
              maximum: 0.5
              description: "Optimal hatch spacing in mm"
            optimal_contour_spacing: 
              type: "number"
              minimum: 0.05
              maximum: 0.5
              description: "Optimal contour spacing in mm"
            optimal_focus_offset: 
              type: "number"
              minimum: -2
              maximum: 2
              description: "Optimal focus offset in mm"
            optimal_chamber_temperature: 
              type: "number"
              minimum: 20
              maximum: 200
              description: "Optimal chamber temperature in °C"
            optimal_oxygen_level: 
              type: "number"
              minimum: 0
              maximum: 1000
              description: "Optimal oxygen level in ppm"
        quality_predictions:
          type: "object"
          properties:
            predicted_quality_score: 
              type: "number"
              minimum: 0
              maximum: 1
              description: "Predicted overall quality score"
            predicted_density: 
              type: "number"
              minimum: 0
              maximum: 1
              description: "Predicted material density"
            predicted_surface_roughness: 
              type: "number"
              minimum: 0
              maximum: 100
              description: "Predicted surface roughness in μm"
            predicted_hardness: 
              type: "number"
              minimum: 0
              maximum: 1000
              description: "Predicted hardness in HV"
        process_metrics:
          type: "object"
          properties:
            estimated_build_time: 
              type: "number"
              minimum: 0
              description: "Estimated build time in hours"
            estimated_material_usage: 
              type: "number"
              minimum: 0
              description: "Estimated material usage in grams"
            estimated_energy_consumption: 
              type: "number"
              minimum: 0
              description: "Estimated energy consumption in kWh"
            estimated_support_volume: 
              type: "number"
              minimum: 0
              description: "Estimated support volume in cm³"
        confidence_scores:
          type: "object"
          properties:
            overall_confidence: 
              type: "number"
              minimum: 0
              maximum: 1
              description: "Overall confidence score for the optimization"
            parameter_confidence: 
              type: "number"
              minimum: 0
              maximum: 1
              description: "Confidence score for parameter optimization"
            quality_confidence: 
              type: "number"
              minimum: 0
              maximum: 1
              description: "Confidence score for quality predictions"
        recommendations:
          type: "array"
          items: 
            type: "object"
            properties:
              type: {"type": "string"}
              priority: {"type": "string", "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]}
              message: {"type": "string"}
              impact: {"type": "string"}
        timestamp: 
          type: "string"
          format: "date-time"
          description: "Timestamp when optimization was performed"
        model_version: 
          type: "string"
          description: "Version of the model used for optimization"
        processing_time_ms: 
          type: "number"
          minimum: 0
          description: "Time taken to process the request in milliseconds"
      required: ["optimal_parameters", "quality_predictions", "process_metrics", "confidence_scores", "timestamp"]
    
    # Rate limiting
    rate_limit:
      requests_per_minute: 1000
      burst_size: 200
      window_size: 60
      
  - name: "optimize_build_strategy"
    path: "/api/v1/optimize/build_strategy"
    method: "POST"
    description: "Optimize build strategy for PBF-LB/M process"
    
    # Input schema
    input_schema:
      type: "object"
      properties:
        material_type: 
          type: "string"
          enum: ["Inconel_718", "Ti6Al4V", "316L_Stainless", "AlSi10Mg"]
        part_geometry_complexity: 
          type: "number"
          minimum: 0
          maximum: 10
        part_volume: 
          type: "number"
          minimum: 0
          maximum: 1000
        part_surface_area: 
          type: "number"
          minimum: 0
          maximum: 10000
        aspect_ratio: 
          type: "number"
          minimum: 0
          maximum: 100
        wall_thickness_min: 
          type: "number"
          minimum: 0.1
          maximum: 10
        overhang_angle_max: 
          type: "number"
          minimum: 0
          maximum: 90
        support_volume_ratio: 
          type: "number"
          minimum: 0
          maximum: 1
        build_orientation_x: 
          type: "number"
          minimum: 0
          maximum: 1
        build_orientation_y: 
          type: "number"
          minimum: 0
          maximum: 1
        build_orientation_z: 
          type: "number"
          minimum: 0
          maximum: 1
        optimization_objectives:
          type: "array"
          items:
            type: "object"
            properties:
              name: {"type": "string"}
              weight: {"type": "number", "minimum": 0, "maximum": 1}
              priority: {"type": "string", "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]}
        constraints:
          type: "array"
          items:
            type: "object"
            properties:
              name: {"type": "string"}
              type: {"type": "string", "enum": ["inequality", "equality"]}
              expression: {"type": "string"}
      required: ["material_type", "part_geometry_complexity", "part_volume", "optimization_objectives"]
    
    # Output schema
    output_schema:
      type: "object"
      properties:
        optimal_strategy:
          type: "object"
          properties:
            layer_thickness: {"type": "number", "minimum": 0.02, "maximum": 0.1}
            hatch_spacing: {"type": "number", "minimum": 0.05, "maximum": 0.5}
            contour_spacing: {"type": "number", "minimum": 0.05, "maximum": 0.5}
            laser_power: {"type": "number", "minimum": 50, "maximum": 1000}
            scan_speed: {"type": "number", "minimum": 100, "maximum": 2000}
            focus_offset: {"type": "number", "minimum": -2, "maximum": 2}
            build_orientation: 
              type: "array"
              items: {"type": "number", "minimum": 0, "maximum": 1}
              minItems: 3
              maxItems: 3
            support_strategy: {"type": "string", "enum": ["minimal", "standard", "extensive"]}
        objective_values:
          type: "object"
          properties:
            build_time: {"type": "number", "minimum": 0}
            quality_score: {"type": "number", "minimum": 0, "maximum": 1}
            material_usage: {"type": "number", "minimum": 0}
            support_volume: {"type": "number", "minimum": 0}
        pareto_front:
          type: "array"
          items:
            type: "object"
            properties:
              build_time: {"type": "number"}
              quality_score: {"type": "number"}
              material_usage: {"type": "number"}
              support_volume: {"type": "number"}
        confidence_score: 
          type: "number"
          minimum: 0
          maximum: 1
        timestamp: 
          type: "string"
          format: "date-time"
        model_version: 
          type: "string"
        processing_time_ms: 
          type: "number"
          minimum: 0
      required: ["optimal_strategy", "objective_values", "confidence_score", "timestamp"]
    
    # Rate limiting
    rate_limit:
      requests_per_minute: 500
      burst_size: 100
      window_size: 60

# Model Configuration
model:
  name: "process_optimization_ensemble"
  version: "production"
  framework: "ensemble"
  format: "mlflow"
  load_strategy: "on_demand"
  mlflow_uri: "http://mlflow:5000"
  
  # Model components
  components:
    - name: "laser_parameter_predictor"
      type: "regression"
      framework: "xgboost"
      weight: 0.3
    - name: "build_strategy_optimizer"
      type: "multi_objective_optimization"
      framework: "genetic_algorithm"
      weight: 0.4
    - name: "material_tuning_models"
      type: "ensemble"
      framework: "multi_model"
      weight: 0.3

# Service Scaling
scaling:
  min_replicas: 2
  max_replicas: 10
  target_cpu_utilization_percent: 70
  target_memory_utilization_percent: 80
  cooldown_period_seconds: 300
  
  # Horizontal Pod Autoscaler
  hpa:
    enabled: true
    scale_up_policy:
      stabilization_window_seconds: 60
      policies:
        - type: "Pods"
          value: 2
          period_seconds: 60
    scale_down_policy:
      stabilization_window_seconds: 300
      policies:
        - type: "Pods"
          value: 1
          period_seconds: 60

# Caching Configuration
caching:
  enabled: true
  type: "redis"
  host: "redis"
  port: 6379
  db: 9
  ttl_seconds: 300  # 5 minutes
  key_strategy: "hash_of_input_features"
  max_cache_size: 10000
  eviction_policy: "lru"
  
  # Cache warming
  cache_warming:
    enabled: true
    strategy: "predictive"
    warm_up_queries: 1000
    refresh_interval: "1h"

# Service Monitoring
monitoring:
  # Health checks
  health_check:
    path: "/health"
    interval_seconds: 10
    timeout_seconds: 5
    failure_threshold: 3
    success_threshold: 1
    
  # Metrics
  metrics:
    - name: "request_count"
      type: "counter"
      description: "Total number of requests"
    - name: "request_duration"
      type: "histogram"
      description: "Request duration in milliseconds"
      buckets: [10, 50, 100, 200, 500, 1000, 2000, 5000]
    - name: "error_rate"
      type: "gauge"
      description: "Error rate percentage"
    - name: "active_connections"
      type: "gauge"
      description: "Number of active connections"
    - name: "cpu_utilization"
      type: "gauge"
      description: "CPU utilization percentage"
    - name: "memory_utilization"
      type: "gauge"
      description: "Memory utilization percentage"
    - name: "model_inference_time"
      type: "histogram"
      description: "Model inference time in milliseconds"
      buckets: [10, 50, 100, 200, 500, 1000, 2000, 5000]
    - name: "cache_hit_rate"
      type: "gauge"
      description: "Cache hit rate percentage"
    - name: "optimization_quality_score"
      type: "histogram"
      description: "Quality score of optimizations"
      buckets: [0.0, 0.2, 0.4, 0.6, 0.8, 1.0]
      
  # Alerts
  alerts:
    - name: "high_error_rate"
      metric: "error_rate"
      operator: ">"
      threshold: 5.0
      period_seconds: 300
      evaluation_periods: 2
      severity: "warning"
      channels: ["slack"]
      description: "Error rate is above 5%"
      
    - name: "high_latency"
      metric: "request_duration"
      statistic: "p95"
      operator: ">"
      threshold: 2000  # 2 seconds
      period_seconds: 300
      evaluation_periods: 2
      severity: "warning"
      channels: ["slack"]
      description: "95th percentile latency is above 2 seconds"
      
    - name: "high_cpu_utilization"
      metric: "cpu_utilization"
      operator: ">"
      threshold: 80
      period_seconds: 300
      evaluation_periods: 2
      severity: "warning"
      channels: ["slack"]
      description: "CPU utilization is above 80%"
      
    - name: "high_memory_utilization"
      metric: "memory_utilization"
      operator: ">"
      threshold: 85
      period_seconds: 300
      evaluation_periods: 2
      severity: "warning"
      channels: ["slack"]
      description: "Memory utilization is above 85%"
      
    - name: "low_cache_hit_rate"
      metric: "cache_hit_rate"
      operator: "<"
      threshold: 70
      period_seconds: 300
      evaluation_periods: 2
      severity: "info"
      channels: ["slack"]
      description: "Cache hit rate is below 70%"

# Security Configuration
security:
  # Authentication
  authentication:
    method: "jwt"
    jwt_public_key_url: "https://your-auth-provider.com/.well-known/jwks.json"
    required_scopes: ["ml:optimize", "process:read", "process:write"]
    token_expiration: "1h"
    
  # Authorization
  authorization:
    method: "rbac"
    policy_engine: "opa"
    policies:
      - name: "process_optimization_access"
        rules:
          - action: "optimize"
            resource: "process"
            conditions:
              - user_has_role: ["ml_engineer", "process_engineer"]
              - user_has_permission: ["process:optimize"]
              
  # Encryption
  encryption:
    data_in_transit: "tls_1_3"
    data_at_rest: "aes_256_gcm"
    key_rotation_days: 90
    
  # Logging
  logging:
    access_logs_enabled: true
    audit_logs_enabled: true
    log_destination: "stdout"
    log_level: "INFO"
    sensitive_data_masking: true

# Service Deployment
deployment:
  # Deployment strategy
  strategy: "rolling"
  replicas: 2
  
  # Resource requirements
  resources:
    requests:
      cpu: "1"
      memory: "2Gi"
      gpu: "0"
    limits:
      cpu: "2"
      memory: "4Gi"
      gpu: "0"
      
  # Health checks
  health_checks:
    liveness:
      path: "/health/live"
      initial_delay: 30
      period: 10
      timeout: 5
      success_threshold: 1
      failure_threshold: 3
    readiness:
      path: "/health/ready"
      initial_delay: 5
      period: 5
      timeout: 3
      success_threshold: 1
      failure_threshold: 3
      
  # Service mesh
  service_mesh:
    enabled: true
    type: "istio"
    traffic_policy:
      load_balancer:
        simple: "ROUND_ROBIN"
      connection_pool:
        tcp:
          max_connections: 100
        http:
          http1_max_pending_requests: 50
          max_requests_per_connection: 2
      circuit_breaker:
        consecutive_errors: 5
        interval: "30s"
        base_ejection_time: "30s"
        max_ejection_percent: 50

# Service Configuration
configuration:
  # Model configuration
  model_config:
    batch_size: 32
    max_sequence_length: 100
    temperature: 0.7
    top_p: 0.9
    top_k: 50
    
  # Optimization configuration
  optimization_config:
    max_iterations: 1000
    convergence_threshold: 0.001
    population_size: 100
    mutation_rate: 0.1
    crossover_rate: 0.8
    
  # Cache configuration
  cache_config:
    default_ttl: 300
    max_size: 10000
    eviction_policy: "lru"
    compression: true
    
  # Logging configuration
  logging_config:
    level: "INFO"
    format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    handlers:
      - type: "console"
      - type: "file"
        filename: "/app/logs/process_optimization_service.log"
        max_bytes: 10485760  # 10MB
        backup_count: 5
